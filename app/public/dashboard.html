<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .top-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }
    .controls {
      flex: 1;
      min-width: 300px;
    }
    .chart-container {
      width: 50%;
      max-width: 400px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 5px;
      text-align: left;
    }
  </style>
</head>
<body>

<h2 id="greeting"></h2>

<div class="top-container">
  <div class="controls">
    <form id="incomeForm">
      <label for="income">Income:</label>
      <input type="number" id="income" name="income" required />
      <button type="submit">Update Income</button>
    </form>

    <p id="incomeDisplay"></p>

    <div id="investControls" style="margin: 10px 0;">
      <label for="percentSlider">Percentage to Invest:</label>
      <input type="range" id="percentSlider" min="0" max="100" value="33" />
      <span id="investPercent">33%</span>
      <br />
      <strong>Investment Amount:</strong>
      $<span id="investAmount">0.00</span>
    </div>

    <form id="expenseForm">
      <label for="expenseName">Expense Name:</label>
      <input type="text" id="expenseName" name="expenseName" required/>
      <label for="expense">Expense Amount:</label>
      <input type="number" id="expense" name="expense" required />
      <button type="submit">Add Expense</button>
    </form>

    <form id="stockForm">
      <label for="StockSymbol">Stock Symbol:</label>
      <input type="text" id="StockSymbol" name="StockSymbol" required/>
      <label for="shares">Shares:</label>
      <input type="number" id="shares" name="shares" required />
      <button type="submit">Add Stock</button>
    </form>
  </div>

  <div class="chart-container">
    <h3>Savings Plan</h3>
    <canvas id="savings_plan"></canvas>
  </div>
</div>

<h3>Your Expenses</h3>
<table>
  <thead><tr><th>Expense</th></tr></thead>
  <tbody id="expenses"></tbody>
</table>

<h3>Your Stocks</h3>
<table>
  <thead><tr><th>Symbol</th><th>Shares</th><th>Price</th><th>Total Value</th></tr></thead>
  <tbody id="stocks"></tbody>
</table>

<h3>Delete Stock</h3>
<input type="text" id="deleteStockSymbol" placeholder="Enter stock symbol (e.g. AAPL)">
<button id="deleteStockBtn">Delete Stock</button>

<h3>Delete Expense</h3>
<input type="text" id="deleteExpenseName" placeholder="Enter expense name (e.g. Rent)">
<button id="deleteExpenseBtn">Delete Expense</button>

<h3>Stock Performance</h3>
<div style="width: 100%; max-width: 800px; margin-top: 20px;">
  <canvas id="stock_performance"></canvas>
</div>

<h3>Stock History (Line Chart)</h3>
<div style="width: 100%; max-width: 800px; margin-top: 20px;">
  <canvas id="stock_history"></canvas>
</div>

<h3>Stock What-If</h3>
<div id="whatIfSection">
 <form id="whatIfForm">
    <label>Which Stock to test?</label>
    <input list="stockList" id="stockWhatIf" name="stockWhatIf" placeholder="e.g. AAPL">
    <datalist id="stockList"> 
    </datalist>

    <label>How many months ago?</label>
    <select id="sdate" name="sdate">
      <option value="1">1 Month</option>
      <option value="3">3 Months</option>
      <option value="6">6 Months</option>
    </select>

    <label>Number of Shares</label>
    <input type="number" id="sharesWhatIf" name="sharesWhatIf" min="1" placeholder="e.g. 10">

    <input type="submit" value="Run WhatIf">
    <div id="stock"></div>
  </form>
  <div id="whatIfResult"></div>
</div>

<script>

let stockChart;
let savingsChart;
let stockHistoryChart;
let apiKey = '';
const params = new URLSearchParams(window.location.search);
const email = params.get('email');

const incomeInput = document.getElementById("income");
const slider = document.getElementById("percentSlider");
const investPercent = document.getElementById("investPercent");
const investAmount = document.getElementById("investAmount");

let currentExpenses = [];

function updateInvestmentAmount() {
  const income = parseFloat(incomeInput.value) || 0;
  const totalExpenses = currentExpenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);
  const netIncome = income - totalExpenses;
  const percent = parseFloat(slider.value);
  const investAmt = ((percent / 100) * netIncome).toFixed(2);

  investPercent.textContent = percent + "%";
  investAmount.textContent = investAmt;

  renderSavingsChart();
}

function renderSavingsChart() {
  const ctx = document.getElementById('savings_plan').getContext('2d');
  const income = parseFloat(incomeInput.value) || 0;
  const totalExpenses = currentExpenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);
  const investAmt = parseFloat(investAmount.textContent) || 0;
  const savings = income - totalExpenses - investAmt;

  if (savingsChart) savingsChart.destroy();

  savingsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Expenses', 'Investments', 'Savings'],
      datasets: [{
        data: [totalExpenses, investAmt, savings],
        backgroundColor: ['#ff6384', '#85BB65', '#36a2eb']
      }]
    },
    options: { responsive: true }
  });
}
slider.addEventListener("input", updateInvestmentAmount);
incomeInput.addEventListener("input", updateInvestmentAmount);

document.addEventListener("DOMContentLoaded", () => {

  document.getElementById("deleteStockBtn").addEventListener("click", async () => {
    const symbol = document.getElementById("deleteStockSymbol").value;
    if (!symbol) return alert("Enter a stock symbol");

    const res = await fetch("/delete-stock", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, symbol })
    });

    if (!res.ok) return alert(`Error: ${await res.text()}`);
    alert((await res.json()).message);
    loadDashboard();
  });

  document.getElementById("deleteExpenseBtn").addEventListener("click", async () => {
    const name = document.getElementById("deleteExpenseName").value;
    if (!name) return alert("Enter an expense name");

    const res = await fetch("/delete-expense", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, name })
    });

    if (!res.ok) return alert(`Error: ${await res.text()}`);
    alert((await res.json()).message);
    loadDashboard();
  });

  async function loadDashboard() {
    const res = await fetch(`/dashboard?email=${encodeURIComponent(email)}`);
    const data = await res.json();
    apiKey = data.apiKey;
    if (!data || !data.username) {
      document.body.innerHTML = "<h2>Error loading dashboard. Please log in again.</h2>";
      setTimeout(() => {
        window.location.href = "login.html";
      }, 2000);
      return;
    }

    document.getElementById('greeting').textContent = `Hello, ${data.username}!`;
    document.getElementById('income').value = data.income || '';
    document.getElementById('incomeDisplay').textContent = `Current Income: ${data.income ?? 'Not set'}`;

    currentExpenses = data.expenses || [];
    renderExpenses(currentExpenses);
    updateInvestmentAmount();

    if (data.stocks && data.stocks.length > 0) {
      await renderStocks(data.stocks);
      await loadStocks(data.stocks, apiKey);
    } else {
      document.getElementById('stocks').innerHTML = "<tr><td colspan='4'>No stocks added</td></tr>";
    }
  }

  async function loadStocks(stocks_array, apiKeyParam) {
    try {
      if (!stocks_array || !stocks_array.length) return;

      const ctx = document.getElementById('stock_performance').getContext('2d');

      const stock_names = [];
      const stock_values = [];
      let maxValue = 0;

      for (let stock of stocks_array) {
        const symbol = stock.symbol || stock.name;
        const priceRes = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKeyParam}`);
        const priceData = await priceRes.json();
        const price = priceData.c || 0;
        const totalValue = price * stock.amount;

        stock_names.push(symbol);
        stock_values.push(totalValue);
        if (totalValue > maxValue) maxValue = totalValue;
      }

      const backgroundColor = stock_values.map(val => val === maxValue ? 'green' : 'gray');
      if (stockChart) stockChart.destroy();

      stockChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: stock_names, datasets: [{ label: 'Stock Total Value', data: stock_values, backgroundColor }] },
        options: { indexAxis: 'y', responsive: true }
      });

    const ctxLine = document.getElementById('stock_history').getContext('2d');
    const datasets = [];
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    let labels = [];

    for (let i = 0; i < stock_names.length; i++) {
      const symbol = stock_names[i];
      const res = await fetch(`/stock-history?symbol=${symbol}`);
      const data = await res.json(); 
      if (!data.length) {
        console.warn(`No historical data for ${symbol}`);
        continue;
      }

      if (labels.length === 0) labels = data.map(h => h.date);

      datasets.push({
        label: symbol,
        data: data.map(h => h.close),
        borderColor: colors[i % colors.length],
        fill: false,
        tension: 0.1
      });
    }

    if (stockHistoryChart) stockHistoryChart.destroy();

    stockHistoryChart = new Chart(ctxLine, {
      type: 'line',
      data: { labels, datasets },
      options: { responsive: true, plugins: { legend: { position: 'top' } } }
    });
    } catch (err) {
      console.error('Failed to load stock performance:', err);
    }
  }

  async function renderStocks(stocks) {
    const tbody = document.getElementById('stocks');
    tbody.innerHTML = '';
    document.getElementById('stockList').innerHTML = '';
  
    for (const stock of stocks) {
      const symbol = stock.symbol;
      if (!symbol || !stock.amount) continue;

      try {
        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`);
        const data = await res.json();
        if (!data || typeof data.c !== "number" || data.c === 0) {
          alert(`Stock symbol "${symbol}" not found. It will not be added.`);
          continue;
        }

        const price = data.c;
        const totalValue = (price * stock.amount).toFixed(2);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="stockNews.html?stockSymbol=${symbol}">${symbol}</a></td>
          <td>${stock.amount}</td>
          <td>$${price.toFixed(2)}</td>
          <td>$${totalValue}</td>
        `;
        tbody.appendChild(tr);

      

        const option = document.createElement('option');
        option.value = symbol;
        document.getElementById('stockList').appendChild(option);

        

      } catch (err) {
        console.error(`Error fetching price for ${symbol}`, err);
      }
    }
  }

  function renderExpenses(expenses) {
    const tbody = document.getElementById('expenses');
    tbody.innerHTML = '';
    expenses.forEach(exp => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${exp.name}: $${exp.amount}</td>`;
      tbody.appendChild(tr);
    });
  }

  document.getElementById('incomeForm').addEventListener('submit', async e => {
    e.preventDefault();
    const income = document.getElementById('income').value;
    await fetch('/update-income', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, income, budgetIndex: 0 }),
    });
    loadDashboard();
  });

  document.getElementById('expenseForm').addEventListener('submit', async e => {
    e.preventDefault();
    const expenseName = document.getElementById('expenseName').value;
    const expense = document.getElementById('expense').value;
    await fetch('/add-expense', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, expenseName, expense, budgetIndex: 0 }),
    });
    loadDashboard();
    e.target.reset();
  });

  document.getElementById('stockForm').addEventListener('submit', async e => {
    e.preventDefault();
    const symbol = document.getElementById('StockSymbol').value.toUpperCase();
    const amount = Number(document.getElementById('shares').value);
    if (!symbol || amount <= 0) return alert("Enter a valid symbol and amount");

    try {
      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`);
      const data = await res.json();
      if (!data || typeof data.c !== "number" || data.c === 0) {
        return alert(`Stock symbol "${symbol}" not found or has no price data`);
      }

      await fetch('/add-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, symbol, amount, budgetIndex: 0 }),
      });

      loadDashboard();
      e.target.reset();
    } catch (err) {
      console.error(err);
      alert("Error validating stock symbol");
    }
  });

  function getDateNMonthAgo(n) {
        const d = new Date();
        d.setMonth(d.getMonth() - n); 
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
 }


  document.getElementById('whatIfForm').addEventListener('submit', async e => {
    e.preventDefault();
    const stockSymbol = document.getElementById('stockWhatIf').value.toUpperCase();
    const sdate = document.getElementById('sdate').value;
    const shares = Number(document.getElementById('sharesWhatIf').value);

    if (!stockSymbol) return alert("Enter a stock symbol");
    if (!sdate) return alert("Select a valid date range");

    const endDate = getDateNMonthAgo(0);
    const startDate = getDateNMonthAgo(Number(sdate));
    const interval = "1d";
    console.log(interval);

    const params = new URLSearchParams({
      stockSymbol,
      period1: startDate,
      period2: endDate,
      interval,
      shares
    });

    const res = await fetch(`/whatIf?${params.toString()}`);
    if (!res.ok) return alert(`Error: ${await res.text()}`);
    const data = await res.json();
    if (!data || data.historicalClose === undefined) {
      return alert(`No historical data found for ${stockSymbol}`);
    } 
    const resultDiv = document.getElementById('whatIfResult');
    resultDiv.innerHTML = `
      <h4>What-If Analysis for ${stockSymbol}</h4>
      <p>Price ${sdate} month(s) ago for ${shares} share(s): $${data.historicalClose.toFixed(2) * shares}</p>
      <p>Current Price for ${shares} shares: $${data.currentPrice * shares}</p>
      <p>Difference: $${data.difference} (${data.percentChange}%)</p>
    `;


  });

  loadDashboard();
});
</script>
</body>
</html>
