<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
</head>
<body>
  <h2 id="greeting"></h2>

  <form id="incomeForm">
    <label for="income">Income:</label>
    <input type="number" id="income" name="income" required />
    <button type="submit">Update Income</button>
  </form>

  <p id="incomeDisplay"></p>
  <br/>

  <!-- Investment controls -->
  <div id="investControls" style="margin: 10px 0;">
    <label for="percentSlider">Percentage to Invest:</label>
    <input type="range" id="percentSlider" min="0" max="100" value="33" />
    <span id="investPercent">33%</span>
    <br />
    <strong>Investment Amount:</strong>
    $<span id="investAmount">0.00</span>
  </div>

  <form id="expenseForm">
    <label for="expenseName">Expense Name:</label>
    <input type="text" id="expenseName" name="expenseName" required/>
    <label for="expense">Expense Amount:</label>
    <input type="number" id="expense" name="expense" required />
    <button type="submit">Add Expense</button>
  </form>

  <form id="stockForm">
    <label for="StockSymbol">Stock Symbol:</label>
    <input type="text" id="StockSymbol" name="StockSymbol" required/>
    <label for="shares">Shares:</label>
    <input type="number" id="shares" name="shares" required />
    <button type="submit">Add Stock</button>
  </form>

  <h3>Your Expenses</h3>
  <table border="1">
    <thead>
      <tr><th>Expense</th></tr>
    </thead>
    <tbody id="expenses"></tbody>
  </table>

  <h3>Your Stocks</h3>
  <table border="1">
    <thead>
      <tr><th>Symbol</th><th>Shares</th><th>Price</th><th>Total Value</th></tr>
    </thead>
    <tbody id="stocks"></tbody>
  </table>

  <h3>Delete Stock</h3>
  <input type="text" id="deleteStockSymbol" placeholder="Enter stock symbol (e.g. AAPL)">
  <button id="deleteStockBtn">Delete Stock</button>

  <h3>Delete Expense</h3>
  <input type="text" id="deleteExpenseName" placeholder="Enter expense name (e.g. Rent)">
  <button id="deleteExpenseBtn">Delete Expense</button>

  <h3>Savings Plan</h3>
  <canvas id="savings_plan" width="400" height="200"></canvas>

<script>
let apiKey = '';
const params = new URLSearchParams(window.location.search);
const email = params.get('email');

const incomeInput = document.getElementById("income");
const slider = document.getElementById("percentSlider");
const investPercent = document.getElementById("investPercent");
const investAmount = document.getElementById("investAmount");

slider.addEventListener("input", updateInvestmentAmount);
incomeInput.addEventListener("input", updateInvestmentAmount);

function updateInvestmentAmount() {
  const income = parseFloat(incomeInput.value) || 0;
  const percent = parseFloat(slider.value);
  const investAmt = ((percent / 100) * income).toFixed(2);
  investPercent.textContent = percent + "%";
  investAmount.textContent = investAmt;
}

document.addEventListener("DOMContentLoaded", () => {

  document.getElementById("deleteStockBtn").addEventListener("click", async () => {
    const symbol = document.getElementById("deleteStockSymbol").value;
    if (!symbol) return alert("Enter a stock symbol");

    const res = await fetch("/delete-stock", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, symbol })
    });

    if (!res.ok) {
      const error = await res.text();
      return alert(`Error: ${error}`);
    }

    const data = await res.json();
    alert(data.message);
    loadDashboard();
  });

  document.getElementById("deleteExpenseBtn").addEventListener("click", async () => {
    const name = document.getElementById("deleteExpenseName").value;
    if (!name) return alert("Enter an expense name");

    const res = await fetch("/delete-expense", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, name })
    });

    if (!res.ok) {
      const error = await res.text();
      return alert(`Error: ${error}`);
    }

    const data = await res.json();
    alert(data.message);
    loadDashboard();
  });

  async function loadDashboard() {
    const res = await fetch(`/dashboard?email=${encodeURIComponent(email)}`);
    const data = await res.json();
    apiKey = data.apiKey;

    document.getElementById('greeting').textContent = `Hello, ${data.username}!`;
    document.getElementById('income').value = data.income || '';
    document.getElementById('incomeDisplay').textContent = `Current Income: ${data.income ?? 'Not set'}`;
    updateInvestmentAmount();

    renderExpenses(data.expenses || []);
    renderSavingsChart(data.expenses || [], data.income || 0);

    if (data.stocks && data.stocks.length > 0) {
      await renderStocks(data.stocks);
    } else {
      document.getElementById('stocks').innerHTML = "<tr><td colspan='4'>No stocks added</td></tr>";
    }
  }

  async function renderStocks(stocks) {
    const tbody = document.getElementById('stocks');
    tbody.innerHTML = '';

    for (const stock of stocks) {
      const symbol = stock.symbol;
      if (!symbol || !stock.amount) continue;

      try {
        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`);
        const data = await res.json();

        if (!data || typeof data.c !== "number" || data.c === 0) {
          alert(`Stock symbol "${symbol}" not found. It will not be added.`);
          continue;
        }

        const price = data.c;
        const totalValue = (price * stock.amount).toFixed(2);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="stockNews.html?stockSymbol=${symbol}">${symbol}</a></td>
          <td>${stock.amount}</td>
          <td>$${price.toFixed(2)}</td>
          <td>$${totalValue}</td>
        `;
        tbody.appendChild(tr);

      } catch (err) {
        console.error(`Error fetching price for ${symbol}`, err);
        alert(`Error fetching price for ${symbol}`);
      }
    }
  }

  function renderExpenses(expenses) {
    const tbody = document.getElementById('expenses');
    tbody.innerHTML = '';
    expenses.forEach(exp => {
      const name = exp.name || '';
      const amount = exp.amount || 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}: $${amount}</td>`;
      tbody.appendChild(tr);
    });
  }

  let savingsChart;

  function renderSavingsChart(expenses, income) {
    const ctx = document.getElementById('savings_plan').getContext('2d');
    const totalExpenses = expenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);
    const savings = income - totalExpenses;

    if (savingsChart) savingsChart.destroy();

    savingsChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Expenses', 'Savings'],
        datasets: [{ data: [totalExpenses, savings], backgroundColor: ['#ff6384', '#36a2eb'] }]
      }
    });
  }

  document.getElementById('incomeForm').addEventListener('submit', async e => {
    e.preventDefault();
    const income = document.getElementById('income').value;
    await fetch('/update-income', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, income, budgetIndex: 0 }),
    });
    loadDashboard();
  });

  document.getElementById('expenseForm').addEventListener('submit', async e => {
    e.preventDefault();
    const expenseName = document.getElementById('expenseName').value;
    const expense = document.getElementById('expense').value;
    await fetch('/add-expense', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, expenseName, expense, budgetIndex: 0 }),
    });
    loadDashboard();
    e.target.reset();
  });

  document.getElementById('stockForm').addEventListener('submit', async e => {
    e.preventDefault();
    const symbol = document.getElementById('StockSymbol').value.toUpperCase();
    const amount = Number(document.getElementById('shares').value);
    
    if (!symbol || amount <= 0) return alert("Enter a valid symbol and amount");

    try {
      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`);
      const data = await res.json();
      if (!data || typeof data.c !== "number" || data.c === 0) {
        return alert(`Stock symbol "${symbol}" not found or has no price data`);
      }

      await fetch('/add-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, symbol, amount, budgetIndex: 0 }),
      });

      loadDashboard();
      e.target.reset();
    } catch (err) {
      console.error(err);
      alert("Error validating stock symbol");
    }
  });

  loadDashboard();
});
</script>
</body>
</html>
