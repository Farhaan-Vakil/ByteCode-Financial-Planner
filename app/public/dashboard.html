<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="index.js" defer></script>
  <script src="graphs.js" defer></script>
  <script src="stock.js" defer></script>
</head>
<body>
  <h2 id="greeting"></h2>

  <form id="incomeForm">
    <label for="income">Income:</label>
    <input type="number" id="income" name="income" required />
    <button type="submit">Update Income</button>
  </form>

  <p id="incomeDisplay"></p>
  <br/>

  <form id="expenseForm">
    <label for="expenseName">Expense Name:</label>
    <input type="text" id="expenseName" name="expenseName" required/>
    <label for="expense">Expense Amount:</label>
    <input type="number" id="expense" name="expense" required />
    <button type="submit">Add Expense</button>
  </form>

  <form id = "stockForm">
    <label for="StockSymbol">Stock Symbol:</label>
    <input type="text" id="StockSymbol" name="StockSymbol" required/>
    <label for="shares">Shares:</label>
    <input type="number" id="shares" name="shares" required />
    <button type="submit">Add Stock</button>
  </form>
  </form>

  <h3>Your Expenses</h3>
  <table border="1">
    <thead>
      <tr>
        <th>Expense</th>
      </tr>
    </thead>
    <tbody id="expenses"></tbody>
  </table>

<h3>Your Stocks</h3>
<table border="1">
  <thead>
    <tr>
      <th>Symbol</th>
      <th>Shares</th>
      <th>Price</th>
      <th>Total Value</th>
    </tr>
  </thead>
  <tbody id="stocks"></tbody>
</table>

  <h3>Savings Plan</h3>
  <canvas id="savings_plan" width="400" height="200"></canvas>

  <h3>Stock perforamnce</h3>
  <canvas id="stock_performance" width="400" height="200"></canvas>

  <script>
      const pastelColors = [
        '#ff9aa2','#ffb7b2','#ffdac1','#e2f0cb',
        '#b5ead7','#c7ceea','#a2d2ff','#bde0fe',
        '#caffbf','#ffd6a5'
      ];

    let apiKey = '';
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const email = params.get('email');

      async function loadDashboard() {
        const res = await fetch(`/dashboard?email=${encodeURIComponent(email)}`);
        const data = await res.json();
        apiKey = data.apiKey;
        document.getElementById('greeting').textContent = `Hello, ${data.username}!`;
        document.getElementById('income').value = data.income || '';
        document.getElementById('incomeDisplay').textContent = `Current Income: ${data.income ?? 'Not set'}`;
        renderExpenses(data.expenses);

        if (document.getElementById('savings_plan')) {
          renderSavingsChart(data.expenses, data.income);
        }
        
        if (data.stocks && data.stocks.length > 0) {
          await renderStocks(data.stocks);
        } else {
          document.getElementById('stocks').innerHTML = "<tr><td colspan='4'>No stocks added</td></tr>";
        }
      }

      async function load_stocks() {
  try {
    const ctx = document.getElementById('stock_performance').getContext('2d');
    const stocks_array = await fetch(`/stock_performance?email=${encodeURIComponent(email)}&budgetIndex=0`).then(res => res.json());

    if (!stocks_array.length) return;

    const stock_names = [];
    const stock_values = [];
    let maxValue = 0;

    for (let i = 0; i < stocks_array.length; i++) {
      const stock = stocks_array[i];
      const priceRes = await fetch(`https://finnhub.io/api/v1/quote?symbol=${stock.name}&token=${apiKey}`);
      const priceData = await priceRes.json();
      const price = priceData.c || 0;
      const totalValue = price * stock.amount;

      stock_names.push(stock.name);
      stock_values.push(totalValue);

      if (totalValue > maxValue) maxValue = totalValue;
    }

    const backgroundColor = [];
    for (let i = 0; i < stock_values.length; i++) {
      backgroundColor[i] = stock_values[i] === maxValue ? 'green' : 'gray';
    }

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: stock_names,
        datasets: [{
          label: 'Stock Total Value',
          data: stock_values,
          backgroundColor
        }]
      },
      options: {
        indexAxis: 'y',
        elements: { bar: { borderWidth: 2 } },
        responsive: true,
        plugins: { legend: { position: 'right' }, title: { display: false } }
      }
    });

  } catch (err) {
    console.error('Failed to load stock performance:', err);
  }
}



      async function renderStocks(stocks) {
        const tbody = document.getElementById('stocks');
        tbody.innerHTML = '';

        for (const stock of stocks) {
          try {
            const priceRes = await fetch(`https://finnhub.io/api/v1/quote?symbol=${stock.name}&token=${apiKey}`);
            const priceData = await priceRes.json();
            const price = priceData.c || 0;
            const totalValue = (price * stock.amount).toFixed(2);

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><a href="stockNews.html?stockSymbol=${stock.name}">${stock.name}</a></td>
              <td>${stock.amount}</td>
              <td>$${price.toFixed(2)}</td>
              <td>$${totalValue}</td>
            `;
            tbody.appendChild(tr);
          } catch (err) {
            console.error(`Error fetching price for ${stock.name}`, err);
          }
        }
      }
      function renderExpenses(expenses) {
        const tbody = document.getElementById('expenses');
        tbody.innerHTML = '';
        expenses.forEach(exp => {
          const name = exp.name || exp.expenseName || '';
          const amount = exp.amount || exp.expense || '';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${name}: $${amount}</td>`;
          tbody.appendChild(tr);
        });
      }

      function renderSavingsChart(expenses, income) {
        const ctx = document.getElementById('savings_plan').getContext('2d');
        const totalExpenses = expenses.reduce((sum, exp) => sum + Number(exp.amount || exp.expense || 0), 0);
        const savings = income - totalExpenses;

        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Expenses', 'Savings'],
            datasets: [{
              data: [totalExpenses, savings],
              backgroundColor: ['#ff6384', '#36a2eb']
            }]
          }
        });
      }

      document.getElementById('incomeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const income = document.getElementById('income').value;
        const budgetIndex = 0;
        await fetch('/update-income', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, income, budgetIndex }),
        });
        loadDashboard();
      });

      document.getElementById('expenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const expenseName = document.getElementById('expenseName').value;
        const expense = document.getElementById('expense').value;
        const budgetIndex = 0;
        await fetch('/add-expense', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, expenseName, expense, budgetIndex }),
        });
        loadDashboard();
        e.target.reset();
      });

      document.getElementById('stockForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const StockSymbol = document.getElementById('StockSymbol').value;
        const shares = document.getElementById('shares').value;
        const budgetIndex = 0;
        await fetch('/add-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, StockSymbol, shares, budgetIndex }),
        });
        loadDashboard();
        e.target.reset();
      });
      loadDashboard().then(load_stocks);
    });
  </script>
</body>
</html>
